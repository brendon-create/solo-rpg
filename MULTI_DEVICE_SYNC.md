# 📱💻 多設備即時同步功能

## ✨ 功能說明

現在 Solo Leveling 支援**多設備即時同步**！您可以在電腦和手機之間無縫切換，數據會自動保持同步。

---

## 🔄 同步機制

### 雙向自動同步

```
設備 A（電腦）               設備 B（手機）
    ↓                           ↓
  修改數據                     修改數據
    ↓                           ↓
    ↓                           ↓
    └─→ Google Sheets ←─────────┘
         （雲端中心）
           ↓
        下次啟動時
           ↓
    自動同步到所有設備
```

### 同步流程

1. **寫入（即時）**：
   - 每次修改數據時，立即寫入 Google Sheets
   - 包含時間戳記錄最後更新時間

2. **讀取（啟動時）**：
   - 每次打開應用時，自動檢查雲端數據
   - 比較本地和雲端的時間戳
   - 自動使用最新的數據

3. **衝突處理**：
   - **時間戳優先**：總是以最後更新的數據為準
   - 特殊數據保護：實時數據（如飲水記錄）會被保留

---

## 🚀 如何使用

### 首次設定（每個設備都需要）

1. **在設備 A（例如電腦）**：
   - 完成初次設定（Google Sheet URL + Apps Script URL）
   - 開始使用，輸入數據

2. **在設備 B（例如手機）**：
   - 打開應用：`https://sololeveling.bcct-world.com/`
   - 輸入**相同的 Google Sheet URL**
   - 完成 Apps Script 部署
   - 輸入**相同的 Apps Script Web App URL**

3. **自動同步**：
   - 手機會自動從雲端讀取電腦上的最新數據！
   - 未來在任何設備修改，其他設備打開時會自動同步

### 日常使用

**場景 1：早上在手機上記錄**
```
手機上打卡 → 自動同步到雲端 → 晚上打開電腦 → 自動載入手機的數據 ✅
```

**場景 2：電腦和手機交替使用**
```
電腦修改 → 同步到雲端 → 手機重新整理頁面 → 看到最新數據 ✅
```

**場景 3：離線修改**
```
設備 A 離線修改 → 連線時上傳 → 設備 B 啟動 → 自動同步最新版本 ✅
```

---

## ⚙️ 更新 Apps Script

### ⚠️ 重要：需要重新部署 Apps Script

舊版 Apps Script 只支援寫入，新版支援讀取。請按以下步驟更新：

1. **前往 Google Apps Script 編輯器**：
   - 開啟您的 Google Sheet
   - 點擊「擴充功能」→「Apps Script」

2. **替換代碼**：
   - 刪除現有代碼
   - 複製 `google-apps-script.js` 中的最新代碼
   - 貼上並儲存

3. **重新部署**：
   - 點擊右上角「部署」→「管理部署作業」
   - 點擊現有部署旁的「編輯」（鉛筆圖示）
   - 在「版本」下拉選單選擇「新版本」
   - 點擊「部署」
   - **複製新的網頁應用程式 URL**（可能跟之前相同，但要確認）

4. **更新應用設定**：
   - 回到 Solo Leveling 應用
   - 點擊右上角「⚙️ 設定」
   - 重新輸入 Apps Script URL（確保是最新的）

---

## 🔍 如何確認同步成功

打開瀏覽器的開發者工具（F12），查看 Console 訊息：

### 成功的同步訊息
```
🔄 檢查雲端數據...
📊 本地更新時間: 2026/02/16 下午3:45:00
☁️ 雲端更新時間: 2026/02/16 下午4:30:00
✅ 雲端數據較新，正在同步到本地...
✅ 已從雲端同步最新數據（已保留本地實時記錄）
```

### 本地已是最新
```
🔄 檢查雲端數據...
📊 本地更新時間: 2026/02/16 下午4:30:00
☁️ 雲端更新時間: 2026/02/16 下午3:45:00
ℹ️ 本地數據已是最新
```

---

## 💡 最佳實踐

### ✅ 推薦做法

1. **每個設備都設定 Apps Script URL**
   - 確保所有設備都能讀寫雲端

2. **使用前重新整理頁面**
   - 確保載入最新數據

3. **固定主要設備**
   - 如果可能，盡量在一個設備上完成大部分記錄

### ⚠️ 注意事項

1. **網路連線**：
   - 同步需要網路連線
   - 離線修改會在下次連線時上傳

2. **實時數據**：
   - 飲水記錄（waterRecords）是實時追蹤
   - 切換設備時，當日飲水記錄可能需要重新輸入

3. **衝突處理**：
   - 如果兩個設備同時修改，最後上傳的會覆蓋
   - 建議避免在多設備上同時編輯

---

## 🐛 故障排除

### 問題：無法從雲端讀取數據

**解決方案**：
1. 確認 Apps Script 已更新到最新版本
2. 確認 Apps Script URL 正確
3. 檢查 Google Sheet 權限（應為「知道連結的任何人都可以編輯」）
4. 查看瀏覽器 Console 的錯誤訊息

### 問題：數據沒有同步

**解決方案**：
1. 重新整理頁面（會觸發雲端同步）
2. 檢查網路連線
3. 確認 Apps Script 部署成功
4. 查看 Google Sheet 是否有最新數據

### 問題：舊數據被覆蓋

**解決方案**：
- Google Sheet 保留所有歷史記錄
- 可以從 Sheet 中手動恢復舊數據
- 建議定期備份 Google Sheet

---

## 📊 技術細節

### 時間戳比較
- 使用 ISO 8601 格式：`2026-02-16T16:30:00.000Z`
- 毫秒級精度
- 時區自動處理

### 數據合併
```javascript
// 雲端數據優先，但保留本地實時數據
const mergedData = {
  ...cloudData,
  hp: {
    ...cloudData.hp,
    waterRecords: localData.hp.waterRecords // 保留本地飲水記錄
  }
}
```

### Google Sheets 欄位
- `最後更新時間`：記錄每次修改的時間戳
- 用於判斷數據新舊

---

## 🎉 享受多設備同步！

現在您可以：
- ✅ 在電腦上規劃目標
- ✅ 在手機上隨時記錄進度
- ✅ 在任何設備上查看完整數據
- ✅ 無縫切換，自動同步

一切都會自動為您處理！🚀
